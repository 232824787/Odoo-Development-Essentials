# Chapter 4 Data Serialization and Module Data
****************

Most Odoo configurations, from user interfaces to security rules, are actually
data records stored in internal Odoo tables. The XML and CSV  les found in modules are not used to run Odoo applications. They are just a means to load those con gurations into the database tables.  

Because of this, an important part of Odoo modules is about representing (serializing) that data into  les so that it can be later loaded into a database.  

Modules can also have initial and demonstration (fixture) data. Data serialization allows adding that to our modules. Additionally, understanding Odoo data serialization formats is important in order to export and import data in the context of a project implementation.  

Before we go into practical cases, we will  rst explore the external identi er concept, which is the key to Odoo data serialization.  

## Understanding external identifiers 理解扩展标识符
All records in the Odoo database have a unique identifier, the `id` field.  

It is a sequential number automatically assigned by the database. However, this automatic identi er can be a challenge when loading interrelated data: how can we reference a related record if we can't know beforehand what database ID will be assigned to it?  

Odoo's answer to this is the external identi er. External identi ers solve this problem by assigning named identi ers to the data records to be loaded. A named identi er can be used by any other piece of record data to reference it later on. Odoo will take care of translating these identi er names into the actual database IDs assigned to them.  

The mechanism behind this is quite simple: Odoo keeps a table with the mapping between the named External IDs and their corresponding numeric database IDs. That is the ir.model.data model.  

To inspect the existing mappings, go to the **Technical** section of the **Settings** menu, and select the **Sequences & Identifiers** | **External Identifiers** menu item.  

For example, if we visit the **External Identifiers** list and filter it by the `todo_app` module, we will see the external identi ers generated by the module created previously.  

img:omit  

You can see that the external identi ers have a **Complete ID** label. This is composed of the module name and the identi er name joined by a dot, for example, `todo_app.action_todo_task`.  

Since only the **Complete ID** is required to be unique, the module name ends up acting as a namespace for identi ers. This means that the same named identi er can be repeated in different modules, and we don't need to worry about identi ers in our module colliding with identi ers in other modules.  

At the top of the list, you can see the `todo_app.action_todo_task` ID. This
is the menu action we created for the module, which is also referenced in the corresponding menu item. By clicking on it, you can open a form with its details: the `action_todo_task` in the `todo_app` module maps to a specific record ID in the `ir.actions.act_window` model.  

img:omit  

Besides providing a way for records to easily reference other records, External IDs also allow avoiding data duplication on repeated imports. If the External ID
is already present, the existing record will be updated, instead of creating a new record. This is why, on subsequent module upgrades, previously loaded records are updated instead of being duplicated.  

### Finding External IDs
When preparing con guration and demonstration data  les for modules, we frequently need to look up existing External IDs that are needed for references.  

We can use the External Identi ers menu shown earlier, but the **Developer Menu** can provide a more convenient method for that. As you may recall from `Chapter 1, Getting Started with Odoo Development`, the **Developer Menu** is activated in the About Odoo option, and then, it is available at the top-left corner of the web client view.  

To  nd the External ID for a data record, on the corresponding Form view, select the **View Metadata** option from the **Developer Menu**. This will display a dialog with the record's database ID and External ID (also known as XML ID).  

As an example, to look up the Demo user ID, we can navigate to its Form view (Settings | Users) and select the View Metadata option, after which we will be shown this:  

img:omit   

To find the External ID for view elements, such as form, tree, search, and action, the **Developer Menu** is also a good help. For that, use its **Manage Views** option or open the information for the desired view using the **Edit <view type>** options, and then select their **View Metadata** option.  

## Exporting and importing data 导入导出数据
We will start exploring how data export and import work in Odoo, and from there, we will move on to the more technical details.  

### Exporting data 导入数据
Data export is a standard feature available in any List view. To use it, we must  rst select the rows to export by selecting the corresponding checkboxes on the far left, and then select the **Export** option from the **More** button.

Here is an example, using the recently created to-do tasks:  

img:omit  

The **Export** option takes us to a dialog form, where we can choose what to export. The **Import Compatible Export** option makes sure that the exported  le can be imported back to Odoo. We will need to use this.  

The export format can be CSV or Excel. We will prefer CSV  le to get a better understanding of the export format. Next, we should pick the columns we want to export and click on the **Export To File** button. This will start the download of a  le with the exported data.  

img:omit  


If we follow these instructions and select the  elds shown in the preceding screenshot, we should end up with a CSV text  le similar to this:  

```csv
   "id","name","user_id/id","date_deadline","is_done"
   "__export__.todo_task_1","Install Odoo","base.user_root","2015-01-
   30","True"
   "__export__.todo_task_2","Create dev database","base.user_
   root","","False"
```

Notice that Odoo automatically exported an additional id column. This is an External ID that is automatically generated for each record. These generated External IDs use `__export__` in place of an actual module name. New identi ers are only assigned to records that don't already have one, and from there on, they are kept bound to the same record. This means that subsequent exports will preserve the same External IDs.  

## Importing data
First we have to make sure the import feature is enabled. This is done in the Settings menu, **Configuration** | **General Settings** option. Under the Import / Export topic, make sure the **Allow users to import data from CSV files** checkbox is enabled.  

With this option enabled, the List views show an **Import** option next to the **Create** button at the top of the list.  

Let's perform a mass edit on our to-do data: open in a spreadsheet or a text editor the CSV  le we just downloaded, then change a few values and add some new rows.  

As mentioned before, the first `id` column provides a unique identi er for each row allowing already existing records to be updated instead of duplicated when we import the data back to Odoo. For new rows we may add to the CSV  le, the id should be left blank, and a new record will be created for them.  

After saving the changes on the CSV  le, click on the **Import** option (next to the **Create** button) and we will be presented with the import assistant. There we should select the CSV file location on disk and click on **Validate** to check its format for correctness. Since the file to import is based on an Odoo export, there is a good chance it will be valid.  

img:omit  

Now we can click on Import and there you go: our modi cations and new records should have been loaded into Odoo.  

### Related records in CSV data files
In the example seen above, the user responsible for each task is a related record in the users model, with a many to one (or foreign key) relation. The column name used for it was `user_id/id` and the  eld values were External IDs for the related records, such as `base.user_root` for the administrator user.  

Relation columns should have `/id` appended to their name, if using External IDs, or `/.id`, if using database (numeric) IDs. Alternatively, a colon (`:`) can be used in place of the slash for the same effect.   

Similarly, **many to many** relations are also supported. An example of a many to many relations is the one between Users and Groups: each User can be in many Groups, and each Group can have many Users. The column name for this type of  eld should have appended a `/id`. The field values accept a comma-separated list of External IDs, surrounded by double quotes.  

For example, the to-do task follower is a many-to-many relation between To-do Tasks and Partners. It's column name could be `follower_ids/id` and a  eld value with two followers could be:  

```csv
"__export__.res_partner_1,__export__.res_partner_2"
```

Finally, **one to many** relations can also be imported through a CSV. The typical example of this type of relations is a document "head" with several "lines".  

We can see an example for such a relation in the company model (form view available in the **Settings** menu): a company can have several bank accounts, each with its own details, and each bank account belongs to (has a many-to-one relation with) only one company.  

It's possible to import companies along with their bank accounts in a single  le. For this, some columns will correspond to the company, and other columns will correspond to the bank account details. The bank details column names should be pre xed with the one-to-many  elds linking the company to the banks; `bank_ids` in this case.  

The first bank account details goes in the same row as its related company data. The next bank account's details go in the next rows, but only the bank details related columns should have values; the company data columns should be empty in those lines.  

Here is an example loading a company with three banks:  

```csv
   id,name,bank_ids/id,bank_ids/acc_number,bank_ids/state
   base.main_company,YourCompany,__export__.res_partner_
   bank_4,123456789,bank
   ,,__export__.res_partner_bank_5,135792468,bank
   ,,__export__.res_partner_bank_6,1122334455,bank
```


Notice that the two last lines begin with two commas: this corresponds to empty values in the  rst two columns, id and name, regarding the head company data. But the remaining columns, regarding bank accounts, have the values for the second and third bank records.  

These are the essentials on working with export and import from the GUI. It's useful to set up data in new Odoo instances, or to prepare data  les to be included in Odoo modules. Next we will learn more about using data  les in modules.  

## Module data
Modules use data  les to load their con gurations into the database, initial data and demonstration data. This can be done using both CSV and XML files. For completeness, the YAML file format can also be used, but this is rarely used for data loading, so we won't be discussing it.  

CSV files used by modules are exactly the same as those we have seen and used for the import feature. When using them in modules, the only additional restriction is that the  le name must match the name of the model to which the data will be loaded.  

A common example is security access, to load into the `ir.model.acess` model. This is usually done using CSV files, and they should be named `ir.model.acess.csv`.  

### Demonstration data
Odoo modules may install demo data. This is useful to provide usage examples for a module and data sets to be used in tests. It's considered good practice for modules to provide demonstration data. Demonstration data for a module is declared using the demo attribute of the `__openerp__.py` manifest file. Just like the data attribute, it is a list of  le names with the corresponding relative paths inside the module.  

We will be adding demonstration data to our `todo_user` module. We can start by exporting some data from the to-do tasks, as explained in the previous section. Next we should save that data in the `todo_user` directory with  le name todo.task.csv. Since this data will be owned by our module, we should edit the id values to replace the `__export__` prefix in the identifiers with the module technical name.  

As an example our `todo.task.csv` data file might look like this:  

```csv
   id,name,user_id/id,date_deadline
   todo_task_a,"Install Odoo","base.user_root","2015-01-30"
   todo_task_b","Create dev database","base.user_root",""
```


We must not forget to add this data  le to the `__openerp__.py` manifest demo attribute:  

```
'demo': ['todo.task.csv'],
```

Next time we update the module, as long as it was installed with demo data enabled, the content of the file will be imported. Note that this data will be rewritten whenever a module upgrade is performed.  

XML files can also be used for demonstration data. Their  le names are not required to match the model to load, because the XML format is much richer and that information is provided by the XML elements inside the file.  

Let's learn more about what XML data  les allow us to do that CSV files don't.  

## XML data files
While CSV  les provide a simple and compact format to serialize data, XML  les are more powerful and give more control over the loading process.  

We have already used XML data files in the previous chapters. The user interface components, such as views and menu items, are in fact records stored in system models. The XML  les in the modules are a means used to load those records into the server.  

To showcase this, we will add a second data file to the todo_user module, named todo_data.xml, with the following content:  

```xml
   <?xml version="1.0"?>
   <openerp>
     <data>
       <!-- Data to load -->
       <record model="todo.task" id="todo_task_c">
         <field name="name">Reinstall Odoo</field>
         <field name="user_id" ref="base.user_root" />
         <field name="date_deadline">2015-01-30</field>
       </record>
     </data>
</openerp>
```

This XML is equivalent to the CSV data  le we have just seen in the previous section.  

XML data  les have a `<openerp>` element containing `<data>` elements, inside of which we can have have several `<record>` elements, corresponding to the CSV data rows.  

A `<record>` element has two mandatory attributes, `model` and `id` (the external identifier for the record), and contains a `<field>` tag for each field to write on.  

Note that the slash notation in field names is not available here: we can't use `<field name="user_id/id">`. Instead the `ref` special attribute is used to reference External IDs. We'll discuss the values for the relational "to many"  elds in a moment.  


### The data noupdate attribute
When the data loading is repeated, existing records from the previous run are rewritten.  

This is important to keep in mind: it means that upgrading a module will overwrite any manual changes that might have been made to the data. Notably, if views were modi ed with customizations, those changes will be lost with the next module upgrade. The correct procedure is to instead create inherited views for the changes we need, as discussed in the `Chapter 3, Inheritance – Extending Existing Applications`.  

This overwrite behavior is the default, but it can be changed, so that when an already created record is loaded again no change is made to it. This is done by adding to the `<data>` element a `noupdate="1"` attribute. With this, its records will be created the  rst time they are loaded, and in subsequent module upgrades nothing will be done to them.  

This allows for manually made customizations to be safe from module upgrades. It is often used with record access rules, allowing them to be adapted to implementation specific needs.  

It is also possible to have more than one `<data>` section in the same XML  le. We can take advantage of this to have a data set with noupdate="1" and another with noupdate="0".  

The `noupdate` flag is stored in the External Identi er information for each record. It's possible to edit it directly using the External Identifier form available in the Technical menu, with the **Non Updatable** checkbox.  


>### Tips
>The `noupdate` attribute is tricky when developing modules, because changes made to the data later will be ignored, and Odoo won't pick up later modi cations. A solution is to keep `noupdate="0"` during development and only set it to 1 once finished.

### Defining Records in XML
Each <record> element has two basic attributes, id and model, and contains <field> elements assigning values to each column. As mentioned before, the id attribute corresponds to the record's External ID and the model to the target model where the record will be written. The <field> elements have available a few different ways to assign values. Let's look at them in detail.
